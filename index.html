<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EasyGo Invoice</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
    
    <style>
        /* --- LAYOUT RESET --- */
        body { 
            margin: 0; padding: 0; height: 100vh; overflow: hidden; 
            display: flex; background: #1e293b; 
            font-family: sans-serif;
        }

        /* --- LEFT PANEL: EDITOR --- */
        #form-panel {
            width: 380px; min-width: 380px;
            background: #0f172a; color: white;
            height: 100%; overflow-y: auto;
            border-right: 1px solid #334155;
            z-index: 50; padding: 20px;
            box-shadow: 5px 0 15px rgba(0,0,0,0.3);
            display: flex; flex-direction: column;
        }

        /* --- RIGHT PANEL: PREVIEW --- */
        #preview-panel {
            flex-grow: 1; height: 100%;
            overflow-y: auto; background: #64748b;
            padding: 40px; display: flex; justify-content: center; align-items: flex-start;
        }

        /* --- PRINT SETTINGS --- */
        @media print {
            @page { margin: 0; size: A4; }
            body { background: white; display: block; height: auto; overflow: visible; }
            #form-panel { display: none !important; }
            #preview-panel { padding: 0; background: white; width: 100%; height: auto; display: block; }
            .invoice-page { margin: 0 !important; box-shadow: none !important; page-break-after: always; }
        }

        /* --- INVOICE GEOMETRY (A4) --- */
        .invoice-page {
            width: 210mm; height: 296mm; /* Safe A4 height */
            background: white; position: relative;
            margin-bottom: 20px; box-shadow: 0 0 20px rgba(0,0,0,0.5);
            box-sizing: border-box; overflow: hidden;
            page-break-after: always;
        }

        /* The Outer White Margin (Safety Zone) */
        .outer-pad {
            width: 100%; height: 100%;
            padding: 10mm; 
            box-sizing: border-box;
        }

        /* The Black Border Box */
        .border-box {
            width: 100%; height: 100%;
            border: 2px solid black;
            display: flex; flex-direction: column;
            justify-content: space-between; 
            /* MODIFIED: Added 5mm top padding for spacing */
            padding: 5mm 10mm 5mm 10mm; 
            box-sizing: border-box;
        }

        /* --- TYPOGRAPHY --- */
        .font-cinzel { font-family: 'Cinzel', serif; font-weight: 700; }
        .font-playfair { font-family: 'Playfair Display', serif; font-weight: 700; }

        /* --- TABLE --- */
        table { width: 100%; border-collapse: collapse; margin-top: 5px; }
        th, td { border: 2px solid black; padding: 0 8px; vertical-align: middle; }
        th { background: #f3f4f6; height: 35px; font-family: 'Cinzel', serif; font-size: 11pt; }
        tr.data-row { height: 42px; font-family: 'Playfair Display', serif; font-size: 11pt; }
        
        /* --- UTILS --- */
        .input-dark { 
            background: #1e293b; border: 1px solid #334155; 
            padding: 8px; width: 100%; font-size: 13px; 
            border-radius: 4px; color: white; margin-bottom: 10px; 
        }
        .input-dark:focus { outline: none; border-color: #3b82f6; }
        .lbl { font-size: 10px; text-transform: uppercase; color: #94a3b8; font-weight: bold; display: block; margin-bottom: 4px; }
        
        /* Tabs */
        .tab-btn {
            flex: 1; padding: 10px; font-weight: bold; font-size: 12px; text-transform: uppercase;
            border-bottom: 2px solid #334155; color: #94a3b8; cursor: pointer;
        }
        .tab-btn.active {
            border-bottom-color: #3b82f6; color: white;
        }
        .hidden-section { display: none; }

    </style>
</head>
<body>

    <div id="form-panel">
        <h2 class="text-2xl font-bold text-blue-400 mb-4 font-cinzel tracking-wider">EasyGo Invoice</h2>
        
        <div class="flex mb-6">
            <div onclick="switchTab('single')" id="tab-single" class="tab-btn active text-center">Single Editor</div>
            <div onclick="switchTab('bulk')" id="tab-bulk" class="tab-btn text-center">Bulk Excel</div>
        </div>

        <div id="mode-single">
            <label class="lbl">Invoice Number</label>
            <input type="text" id="inNo" value="EG00001" oninput="renderSingle()" class="input-dark">
            
            <label class="lbl">Date Issued</label>
            <input type="text" id="inDate" value="17 Dec 2026" oninput="renderSingle()" class="input-dark">
            
            <label class="lbl">Customer Name</label>
            <input type="text" id="inTo" placeholder="Enter Client Name" oninput="renderSingle()" class="input-dark">
            
            <label class="lbl">Address</label>
            <textarea id="inAddr" oninput="renderSingle()" rows="2" placeholder="Enter Client Address" class="input-dark"></textarea>

            <div class="mt-4 border-t border-gray-700 pt-4">
                <div class="flex justify-between items-end mb-2">
                    <label class="lbl text-blue-400 text-xs">Line Items</label>
                    <button onclick="resetItems()" class="text-[10px] text-red-400 hover:text-red-300 underline">Clear All</button>
                </div>
                
                <div id="items-container" class="space-y-2 mb-4">
                    </div>
                
                <button onclick="addItem()" class="w-full bg-slate-700 hover:bg-slate-600 text-white py-2 rounded text-xs font-bold transition uppercase tracking-wider mb-4">
                    + Add New Item
                </button>
            </div>
        </div>

        <div id="mode-bulk" class="hidden-section flex-col h-full">
            <div class="bg-slate-800 p-4 rounded border border-slate-700 mb-4">
                <h3 class="font-bold text-white mb-2 text-sm">Step 1: Get Template</h3>
                <p class="text-xs text-slate-400 mb-3">Download the Excel template. Do not change the header names.</p>
                <button onclick="downloadTemplate()" class="bg-blue-600 hover:bg-blue-500 text-white text-xs py-2 px-3 rounded font-bold">
                    ‚¨á Download Template.xlsx
                </button>
            </div>

            <div class="bg-slate-800 p-4 rounded border border-slate-700 mb-4">
                <h3 class="font-bold text-white mb-2 text-sm">Step 2: Upload Data</h3>
                <input type="file" id="excelInput" accept=".xlsx, .xls, .csv" onchange="handleFileUpload(this)" class="block w-full text-xs text-slate-300 file:mr-4 file:py-2 file:px-4 file:rounded file:border-0 file:text-xs file:font-semibold file:bg-slate-700 file:text-white hover:file:bg-slate-600"/>
                <div id="uploadStatus" class="mt-2 text-xs text-emerald-400 font-bold hidden"></div>
            </div>

            <div class="bg-slate-900 p-3 rounded border border-slate-800 text-xs text-slate-500 italic">
                Note: Rows with the same <strong>Invoice No</strong> will be grouped into a single invoice.
            </div>
        </div>

        <div class="mt-auto pt-4">
            <button onclick="window.print()" class="w-full bg-emerald-600 hover:bg-emerald-500 text-white font-bold py-4 rounded shadow-xl uppercase tracking-widest text-sm">
                üñ®Ô∏è Print Invoices
            </button>
        </div>
    </div>

    <div id="preview-panel">
        <div id="pages-wrapper" class="flex flex-col items-center">
            </div>
    </div>

    <datalist id="presets">
        <option value="Veg Momos [39 pcs]">
        <option value="Paneer Momos [39 pcs]">
        <option value="Cheese Corn Momos [36 pcs]">
        <option value="Mini Samosa [33 pcs]">
        <option value="Cheese Balls [39 pcs]">
        <option value="Cheese Corn Nuggets [33 pcs]">
        <option value="French Fries [2.5 Kg]">
    </datalist>

    <script>
        // --- CONSTANTS ---
        const PRESETS = {
            "Veg Momos [39 pcs]": 120, "Paneer Momos [39 pcs]": 165,
            "Cheese Corn Momos [36 pcs]": 150, "Mini Samosa [33 pcs]": 250,
            "Cheese Balls [39 pcs]": 630, "Cheese Corn Nuggets [33 pcs]": 680,
            "French Fries [2.5 Kg]": 250
        };

        // --- STATE ---
        let currentMode = 'single';
        let singleItems = [{ desc: "", qty: "", rate: "" }];
        let bulkInvoices = [];

        // --- TABS LOGIC ---
        function switchTab(mode) {
            currentMode = mode;
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`tab-${mode}`).classList.add('active');
            
            document.getElementById('mode-single').style.display = mode === 'single' ? 'block' : 'none';
            document.getElementById('mode-bulk').style.display = mode === 'bulk' ? 'flex' : 'none';

            if(mode === 'single') renderSingle();
            else renderBulk();
        }

        // --- EXCEL LOGIC ---
        function downloadTemplate() {
            // 15 Real-World Scenarios
            const data = [
                // --- SCENARIO 1: The "Morning Coffee" (Single Item) ---
                { "Invoice No": "EG-001", "Date": "01 Jan 2026", "Customer Name": "Nishant Jaiswal", "Address": "114 Prime Square, Indore", "Item": "Hot Coffee", "Qty": 1, "Rate": 40 },

                // --- SCENARIO 2: The "Lunch Combo" (Multiple Items, Same Invoice) ---
                { "Invoice No": "EG-002", "Date": "01 Jan 2026", "Customer Name": "Rahul Sharma", "Address": "56 Scheme No 54, Indore", "Item": "Veg Momos [39 pcs]", "Qty": 1, "Rate": 120 },
                { "Invoice No": "EG-002", "Date": "01 Jan 2026", "Customer Name": "Rahul Sharma", "Address": "56 Scheme No 54, Indore", "Item": "Coke", "Qty": 2, "Rate": 40 },

                // --- SCENARIO 3: The "Evening Return" (SAME Person, SAME Day, NEW Invoice) ---
                { "Invoice No": "EG-003", "Date": "01 Jan 2026", "Customer Name": "Nishant Jaiswal", "Address": "114 Prime Square, Indore", "Item": "French Fries [2.5 Kg]", "Qty": 1, "Rate": 250 },

                // --- SCENARIO 4: The "Next Day Visit" (Same Person, New Date) ---
                { "Invoice No": "EG-004", "Date": "02 Jan 2026", "Customer Name": "Nishant Jaiswal", "Address": "114 Prime Square, Indore", "Item": "Cheese Balls [39 pcs]", "Qty": 1, "Rate": 630 },

                // --- SCENARIO 5: The "Family Feast" (Medium Order - 5 Items) ---
                { "Invoice No": "EG-005", "Date": "03 Jan 2026", "Customer Name": "The Gupta Family", "Address": "Royal Bungalows, Indore", "Item": "Paneer Momos [39 pcs]", "Qty": 2, "Rate": 165 },
                { "Invoice No": "EG-005", "Date": "03 Jan 2026", "Customer Name": "The Gupta Family", "Address": "Royal Bungalows, Indore", "Item": "Veg Momos [39 pcs]", "Qty": 2, "Rate": 120 },
                { "Invoice No": "EG-005", "Date": "03 Jan 2026", "Customer Name": "The Gupta Family", "Address": "Royal Bungalows, Indore", "Item": "Cheese Corn Nuggets", "Qty": 1, "Rate": 680 },
                { "Invoice No": "EG-005", "Date": "03 Jan 2026", "Customer Name": "The Gupta Family", "Address": "Royal Bungalows, Indore", "Item": "Coke Large", "Qty": 4, "Rate": 80 },
                { "Invoice No": "EG-005", "Date": "03 Jan 2026", "Customer Name": "The Gupta Family", "Address": "Royal Bungalows, Indore", "Item": "Water Bottle", "Qty": 4, "Rate": 20 },

                // --- SCENARIO 6: The "Corporate Party" (Pagination Test - 2 Pages) ---
                { "Invoice No": "EG-006", "Date": "04 Jan 2026", "Customer Name": "Upgrad Corporate", "Address": "IT Park, Indore", "Item": "Bulk Veg Momos", "Qty": 10, "Rate": 120 },
                { "Invoice No": "EG-006", "Date": "04 Jan 2026", "Customer Name": "Upgrad Corporate", "Address": "IT Park, Indore", "Item": "Bulk Paneer Momos", "Qty": 10, "Rate": 165 },
                { "Invoice No": "EG-006", "Date": "04 Jan 2026", "Customer Name": "Upgrad Corporate", "Address": "IT Park, Indore", "Item": "French Fries Platter", "Qty": 5, "Rate": 250 },
                { "Invoice No": "EG-006", "Date": "04 Jan 2026", "Customer Name": "Upgrad Corporate", "Address": "IT Park, Indore", "Item": "Dip: Spicy Red", "Qty": 20, "Rate": 10 },
                { "Invoice No": "EG-006", "Date": "04 Jan 2026", "Customer Name": "Upgrad Corporate", "Address": "IT Park, Indore", "Item": "Dip: Mayo", "Qty": 20, "Rate": 10 },
                { "Invoice No": "EG-006", "Date": "04 Jan 2026", "Customer Name": "Upgrad Corporate", "Address": "IT Park, Indore", "Item": "Dip: Mint", "Qty": 20, "Rate": 10 },
                { "Invoice No": "EG-006", "Date": "04 Jan 2026", "Customer Name": "Upgrad Corporate", "Address": "IT Park, Indore", "Item": "Disposables (Plate)", "Qty": 50, "Rate": 5 },
                { "Invoice No": "EG-006", "Date": "04 Jan 2026", "Customer Name": "Upgrad Corporate", "Address": "IT Park, Indore", "Item": "Tissues Pack", "Qty": 5, "Rate": 40 },
                { "Invoice No": "EG-006", "Date": "04 Jan 2026", "Customer Name": "Upgrad Corporate", "Address": "IT Park, Indore", "Item": "Trash Bags", "Qty": 2, "Rate": 20 },
                { "Invoice No": "EG-006", "Date": "04 Jan 2026", "Customer Name": "Upgrad Corporate", "Address": "IT Park, Indore", "Item": "Coke Crate", "Qty": 2, "Rate": 500 },
                { "Invoice No": "EG-006", "Date": "04 Jan 2026", "Customer Name": "Upgrad Corporate", "Address": "IT Park, Indore", "Item": "Sprite Crate", "Qty": 2, "Rate": 500 },
                { "Invoice No": "EG-006", "Date": "04 Jan 2026", "Customer Name": "Upgrad Corporate", "Address": "IT Park, Indore", "Item": "Delivery Charge", "Qty": 1, "Rate": 200 },

                // --- SCENARIO 7: The "Long Address" (Testing Layout Wrap) ---
                { "Invoice No": "EG-007", "Date": "05 Jan 2026", "Customer Name": "Sacha Dubois", "Address": "Flat 402, Building C, Kingdom Apartments, Near The Old Banyan Tree, Behind City Mall, Vijay Nagar, Indore, MP 452010", "Item": "Mini Samosa [33 pcs]", "Qty": 1, "Rate": 250 },

                // --- SCENARIO 8: The "Long Item Name" (Testing Table Wrap) ---
                { "Invoice No": "EG-008", "Date": "06 Jan 2026", "Customer Name": "Foodie Club", "Address": "Bhopal", "Item": "Special Assorted Platter (2pcs Veg, 2pcs Paneer, 2pcs Corn, 2pcs Fried) with Extra Dip", "Qty": 2, "Rate": 350 },

                // --- SCENARIO 9: The "High Roller" (High Value Order) ---
                { "Invoice No": "EG-009", "Date": "07 Jan 2026", "Customer Name": "Wedding Caterers", "Address": "Sayaji Hotel", "Item": "Cheese Corn Nuggets [33 pcs]", "Qty": 50, "Rate": 680 },
                
                // --- SCENARIO 10: The "Tiny Order" (Minimum Value) ---
                { "Invoice No": "EG-010", "Date": "07 Jan 2026", "Customer Name": "Student", "Address": "Hostel 4", "Item": "Extra Dip", "Qty": 1, "Rate": 10 },

                // --- SCENARIO 11: The "Walk-In" (No Address Provided) ---
                { "Invoice No": "EG-011", "Date": "08 Jan 2026", "Customer Name": "Guest User", "Address": "N/A", "Item": "Veg Momos", "Qty": 1, "Rate": 120 },

                // --- SCENARIO 12: The "Split Payment" (Person pays half cash/online - Just Itemized) ---
                { "Invoice No": "EG-012", "Date": "09 Jan 2026", "Customer Name": "Ravi Kumar", "Address": "Indore", "Item": "Veg Momos", "Qty": 1, "Rate": 120 },
                { "Invoice No": "EG-012", "Date": "09 Jan 2026", "Customer Name": "Ravi Kumar", "Address": "Indore", "Item": "Payment Fee", "Qty": 1, "Rate": 5 },

                // --- SCENARIO 13: The "Mega Event" (Pagination Test - 3 Pages) ---
                // Simulating 25 items for a wedding stall
                ...Array.from({length: 25}, (_, i) => ({
                    "Invoice No": "EG-013", 
                    "Date": "10 Jan 2026", 
                    "Customer Name": "Grand Wedding Stall", 
                    "Address": "Marriott Convention Center", 
                    "Item": `Catering Item #${i+1} - Batch A`, 
                    "Qty": 5, 
                    "Rate": 200
                })),

                // --- SCENARIO 14: The "Inventory Clearance" (Odd Quantities) ---
                { "Invoice No": "EG-014", "Date": "11 Jan 2026", "Customer Name": "Staff Meal", "Address": "In-Store", "Item": "Broken/Odd Momos", "Qty": 13, "Rate": 10 },

                // --- SCENARIO 15: The "Late Night Cravings" (Date change at midnight) ---
                { "Invoice No": "EG-015", "Date": "12 Jan 2026", "Customer Name": "Night Owl", "Address": "Indore", "Item": "Maggi", "Qty": 2, "Rate": 50 }
            ];
            
            // Flatten the array (because Scenario 13 uses a generator)
            const flatData = data.flat();

            const ws = XLSX.utils.json_to_sheet(flatData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Template");
            XLSX.writeFile(wb, "EasyGo_Full_Scenario_Template.xlsx");
        }

        function handleFileUpload(input) {
            const file = input.files[0];
            if(!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                // cellDates: true forces parsing of Excel serial dates to JS Date objects
                const workbook = XLSX.read(data, {type: 'array', cellDates: true});
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(firstSheet);
                processBulkData(jsonData);
            };
            reader.readAsArrayBuffer(file);
        }

        // Helper to fix Excel Dates (Numbers or Date Objects)
        function formatExcelDate(dateVal) {
            if (!dateVal) return "";
            if (typeof dateVal === 'number') {
                const date = new Date(Math.round((dateVal - 25569) * 86400 * 1000));
                return date.toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' });
            }
            if (dateVal instanceof Date) {
                 return dateVal.toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' });
            }
            return dateVal;
        }

        function processBulkData(data) {
            const grouped = {};
            data.forEach(row => {
                const no = row["Invoice No"] || "UNKNOWN";
                const rawDate = row["Date"];
                const cleanDate = formatExcelDate(rawDate);

                if(!grouped[no]) {
                    grouped[no] = {
                        no: no,
                        date: cleanDate, 
                        to: row["Customer Name"] || "",
                        addr: row["Address"] || "",
                        items: []
                    };
                }
                if(row["Item"]) {
                    grouped[no].items.push({
                        desc: row["Item"],
                        qty: row["Qty"],
                        rate: row["Rate"]
                    });
                }
            });
            bulkInvoices = Object.values(grouped);
            const status = document.getElementById('uploadStatus');
            status.innerText = `‚úÖ Loaded ${bulkInvoices.length} Invoices ready to print!`;
            status.classList.remove('hidden');
            renderBulk();
        }

        // --- DYNAMIC FONT SIZER ---
        function getFontSizeClass(text, type) {
            if (!text) return type === 'addr' ? "text-lg" : "text-2xl";
            const len = text.length;
            
            if (type === 'addr') {
                if (len > 100) return "text-[9pt] leading-tight";
                if (len > 70) return "text-[11pt] leading-tight";
                if (len > 40) return "text-[12pt] leading-snug";
                return "text-lg leading-tight";
            }
            if (type === 'name') {
                if (len > 30) return "text-lg";
                if (len > 20) return "text-xl";
                return "text-2xl";
            }
            return "text-lg";
        }

        // --- RENDERERS ---
        function renderSingle() {
            if(currentMode !== 'single') return;
            const data = {
                no: document.getElementById('inNo').value,
                date: document.getElementById('inDate').value,
                to: document.getElementById('inTo').value,
                addr: document.getElementById('inAddr').value,
                items: singleItems
            };
            document.getElementById('pages-wrapper').innerHTML = generateInvoiceHTML(data);
        }

        function renderBulk() {
            if(currentMode !== 'bulk') return;
            const wrapper = document.getElementById('pages-wrapper');
            if(bulkInvoices.length === 0) {
                wrapper.innerHTML = `<div class="text-white text-center mt-20 opacity-50">Upload an Excel file to see previews here.</div>`;
                return;
            }
            let fullHTML = '';
            bulkInvoices.forEach(inv => { fullHTML += generateInvoiceHTML(inv); });
            wrapper.innerHTML = fullHTML;
        }

        // 3. Core HTML Generator (Pure Function)
        function generateInvoiceHTML(invoiceData) {
            // Calculate dynamic classes
            const addrClass = getFontSizeClass(invoiceData.addr, 'addr');
            const nameClass = getFontSizeClass(invoiceData.to, 'name');

            // Process Items
            const processedItems = invoiceData.items.map(i => {
                const q = parseFloat(i.qty) || 0;
                const r = parseFloat(i.rate) || 0;
                const hasData = i.desc || i.qty || i.rate;
                return { 
                    desc: i.desc,
                    displayQty: i.qty,
                    displayRate: i.rate ? `‚Çπ ${i.rate}` : '',
                    displaySub: (q && r) ? `‚Çπ ${q*r}` : '',
                    sub: q*r,
                    isEmpty: !hasData 
                };
            });

            const total = processedItems.reduce((a,b) => a + b.sub, 0);

            // Pagination Logic
            const chunks = [];
            if(processedItems.length === 0) chunks.push([]);
            else {
                for(let i=0; i<processedItems.length; i+=10) chunks.push(processedItems.slice(i, i+10));
            }

            let html = '';

            chunks.forEach((chunk, pageIdx) => {
                const isLast = pageIdx === chunks.length - 1;
                const pageNum = pageIdx + 1;
                let rows = '';

                chunk.forEach((it, i) => {
                    const sn = (pageIdx*10)+i+1;
                    const showSn = !it.isEmpty ? sn : '';
                    rows += `
                        <tr class="data-row">
                            <td class="text-center">${showSn}</td>
                            <td>${it.desc || ''}</td>
                            <td class="text-center font-bold font-sans">${it.displayQty || ''}</td>
                            <td class="text-center font-bold font-sans">${it.displayRate || ''}</td>
                            <td class="text-center font-bold font-sans">${it.displaySub || ''}</td>
                        </tr>`;
                });

                // Fill empty rows
                for(let i=0; i < (10 - chunk.length); i++) {
                    rows += `<tr class="data-row"><td></td><td></td><td></td><td></td><td></td></tr>`;
                }

                const totalText = isLast ? `‚Çπ ${total}` : `<span class="text-sm italic font-normal text-gray-500">Continued...</span>`;

                html += `
                <div class="invoice-page">
                    <div class="outer-pad">
                        <div class="border-box">
                            <div>
                                <div class="w-full mb-4">
                                    <img src="https://github.com/Clean-Scripts/Easygo-Invoice/blob/main/invoice-top.png?raw=true" class="w-full h-auto object-contain">
                                </div>
                                
                                <div class="flex justify-between items-end mb-2 px-1">
                                    <div class="w-1/3">
                                        <div class="font-cinzel font-bold text-lg leading-none mb-1">DATE ISSUED:</div>
                                        <div class="text-xl font-bold font-playfair leading-none mb-4">${invoiceData.date}</div>
                                        <div class="font-cinzel font-bold text-lg leading-none mb-1">INVOICE NO:</div>
                                        <div class="text-xl font-bold font-sans leading-none">${invoiceData.no}</div>
                                    </div>
                                    <div class="text-right w-2/3">
                                        <div class="font-cinzel font-bold text-lg leading-none mb-1">ISSUED TO:</div>
                                        <div class="${nameClass} font-bold font-playfair leading-none mb-1">${invoiceData.to}</div>
                                        <div class="${addrClass} font-bold w-full ml-auto whitespace-pre-line text-right">${invoiceData.addr}</div>
                                    </div>
                                </div>

                                <table>
                                    <thead>
                                        <tr>
                                            <th class="w-12 text-center">S.No.</th>
                                            <th>DESCRIPTION</th>
                                            <th class="w-24 text-center">QTY</th>
                                            <th class="w-28 text-center">RATE</th>
                                            <th class="w-36 text-center">SUBTOTAL</th>
                                        </tr>
                                    </thead>
                                    <tbody>${rows}</tbody>
                                </table>

                                <div class="border-2 border-black border-t-0 flex">
                                    <div class="flex-grow text-right pr-4 py-2 font-cinzel font-bold text-xl tracking-widest flex items-center justify-end">GRAND TOTAL</div>
                                    <div class="w-36 border-l-2 border-black text-center py-2 font-bold font-sans text-2xl italic flex items-center justify-center">${totalText}</div>
                                </div>
                            </div>

                            <div class="pb-2">
                                <div class="w-full">
                                    <img src="https://github.com/Clean-Scripts/Easygo-Invoice/blob/main/invoice-bottom.png?raw=true" class="w-full h-auto object-contain">
                                </div>
                                <div class="text-right text-[9pt] font-bold mt-1">Page ${pageNum} of ${chunks.length}</div>
                            </div>
                        </div>
                    </div>
                </div>`;
            });
            return html;
        }

        // --- SINGLE MODE UI LOGIC ---
        function renderItemsInput() {
            const container = document.getElementById('items-container');
            container.innerHTML = '';
            singleItems.forEach((item, idx) => {
                container.innerHTML += `
                    <div class="group relative bg-slate-800 p-2 rounded border border-slate-700">
                        <div class="absolute -left-2 top-2 bg-slate-900 text-[10px] text-slate-500 px-1 rounded border border-slate-700">${idx+1}</div>
                        <div class="flex gap-2 mb-2">
                            <input list="presets" value="${item.desc}" oninput="updateItem(${idx}, 'desc', this.value)" class="bg-slate-900 border border-slate-600 rounded px-2 py-1 text-xs text-white w-full outline-none focus:border-blue-500" placeholder="Description">
                            <button onclick="delItem(${idx})" class="text-red-500 hover:text-white px-2">√ó</button>
                        </div>
                        <div class="flex gap-2">
                            <input value="${item.qty}" oninput="updateItem(${idx}, 'qty', this.value)" class="bg-slate-900 border border-slate-600 rounded px-2 py-1 text-xs text-white w-1/2 outline-none focus:border-blue-500 text-center" placeholder="Qty">
                            <input type="number" value="${item.rate}" oninput="updateItem(${idx}, 'rate', this.value)" class="bg-slate-900 border border-slate-600 rounded px-2 py-1 text-xs text-white w-1/2 outline-none focus:border-blue-500 text-center" placeholder="Rate">
                        </div>
                    </div>
                `;
            });
            renderSingle();
        }

        function updateItem(idx, key, val) {
            singleItems[idx][key] = val;
            if(key === 'desc' && PRESETS[val]) {
                singleItems[idx].rate = PRESETS[val];
                renderItemsInput();
            } else {
                renderSingle();
            }
        }

        function addItem() { singleItems.push({desc:"", qty:"", rate:""}); renderItemsInput(); }
        function delItem(idx) { if(singleItems.length > 1) singleItems.splice(idx,1); renderItemsInput(); }
        function resetItems() { singleItems = [{desc:"", qty:"", rate:""}]; renderItemsInput(); }

        // Init
        renderItemsInput();
    </script>
</body>
</html>
